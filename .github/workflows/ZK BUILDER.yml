name: ZK BUILDER
on:
  workflow_dispatch:
    inputs:
      URL:
        description: "OTA ROM URL"
        required: true
      URL2:
        description: "FASTBOOT ROM URL"
      EXT4:
        description: "FORCE EXT4"
        type: boolean
        default: 'false'
      DECRYPT:
        description: "DECRYPT DATA"
        type: boolean
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v6.0.2

      - name: Check free disk space
        id: diskcheck
        run: |
          FREE_GB=$(df -BG / | awk 'NR==2 {gsub("G","",$4); print $4}')
          echo "Free disk space: ${FREE_GB}GB"
          if [ "$FREE_GB" -lt 50 ]; then
            echo "need_cleanup=true" >> $GITHUB_OUTPUT
          else
            echo "need_cleanup=false" >> $GITHUB_OUTPUT
          fi

      - name: Maximize build disk space
        if: steps.diskcheck.outputs.need_cleanup == 'true'
        uses: AdityaGarg8/remove-unwanted-software@v5
        with:
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'
          remove-large-packages: 'true'
          remove-cached-tools: 'true'

      - name: Setup build environment
        run: |
          cd "$GITHUB_WORKSPACE"
          sudo timedatectl set-timezone UTC
          sudo apt-get update > /dev/null 2>&1
          sudo apt-get install -y python3 p7zip-full openjdk-17-jdk-headless openssh-client aria2 android-sdk-libsparse-utils > /dev/null 2>&1
          DATE=$(TZ=Asia/Ho_Chi_Minh date +"%y%m%d")
          ROM_URL="${{ github.event.inputs.URL }}"
          ROM_NAME="$(basename "${ROM_URL%%\?*}")"
          if [[ "$ROM_NAME" == *"-OS"* ]]; then
            if [[ "$ROM_NAME" =~ ^([a-z0-9]+)-ota_full-(OS[0-9.]+)\.([A-Z0-9]+)-user-([0-9.]+)-.*\.zip$ ]]; then
              DEVICE_RAW="${BASH_REMATCH[1]}"
              DEVICE="${DEVICE_RAW^^}"
              OS_VER="${BASH_REMATCH[2]}"
              REGION="${BASH_REMATCH[3]}"
              ANDROID="${BASH_REMATCH[4]}"
              ROM_VER="${OS_VER%%.*}"
            else
              export ZK_NAME="ZKOS_V1.0_${DATE}"
            fi
            export ZK_NAME="ZKOS_V1.0_${DEVICE}_${OS_VER}.${REGION}_${ANDROID}_${DATE}"
          elif [[ "$ROM_NAME" == *"_V14"* ]]; then
            if [[ "$ROM_NAME" =~ ^miui_([^_]+)_(V[0-9.]+)\.([A-Z0-9]+)_[^_]+_([0-9.]+)\.zip$ ]]; then
              DEVICE="${BASH_REMATCH[1]}"
              MIUI_VER="${BASH_REMATCH[2]}"
              REGION="${BASH_REMATCH[3]}"
              ANDROID="${BASH_REMATCH[4]}"
              ROM_VER="V14"
            else
              export ZK_NAME="ZKUI_V1.0_${DATE}"
            fi
            export ZK_NAME="ZKUI_V1.0_${DEVICE}_${MIUI_VER}.${REGION}_${ANDROID}_${DATE}"
          else
            echo "Unable to set ZK ROM name"
            exit 1
          fi
          echo "ZK_NAME=$ZK_NAME" >> $GITHUB_ENV
          echo "DEVICE=$DEVICE" >> $GITHUB_ENV
          echo "$ZK_NAME"
          mkdir -p ~/.ssh
          echo "${{ secrets.SF_SSH_KEY }}" > ~/.ssh/sf_key
          chmod 600 ~/.ssh/sf_key
          echo "${{ secrets.PRIVATE_REPO_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null

      - name: Download ROM files
        run: |
          cd "$GITHUB_WORKSPACE"
          mkdir -p "$GITHUB_WORKSPACE/ROM"
          cd "$GITHUB_WORKSPACE/ROM"
          timeout 9000 aria2c -s16 -x16 -j$(nproc) -c -U "Mozilla/5.0" -o "${ZK_NAME}.zip" "${{ github.event.inputs.URL }}" || exit 1
          #aria2c --user-agent=curl/8.16.0 https://sourceforge.net/projects/projectzk/files/super_size.json
          super_json="super_size.json"
          echo '{
            "MARBLE": {
              "super_size": 9663676416
            }
          }' "$super_json"
          if [ -f "$super_json" ] && jq -e --arg m "$DEVICE" '.[$m]' "$super_json" >/dev/null; then
            super_size=$(jq -r --arg m "$DEVICE" '.[$m].super_size' "$super_json")
          else
            if [ -n "${{ github.event.inputs.URL2 }}" ]; then
              timeout 9000 aria2c -s16 -x16 -j$(nproc) -c -U "Mozilla/5.0" -o "FASTBOOT.tgz" "${{ github.event.inputs.URL2 }}" || exit 1
              mkdir -p "FASTBOOT" && tar -xzf "FASTBOOT.tgz" -C "FASTBOOT" > /dev/null 2>&1 && rm -rf "FASTBOOT.tgz"
              simg2img FASTBOOT/*/images/super.img "FASTBOOT/super.img"
              super_size=$(stat -c %s "FASTBOOT/super.img") && rm -rf FASTBOOT
            fi
            if ! jq -e --arg m "$DEVICE" '.[$m]' "$super_json" >/dev/null; then
              jq --arg m "$DEVICE" --argjson s "$super_size" '. + {($m): {super_size: $s}}' \
              "${super_json:-/dev/null}" 2>/dev/null > tmp.json && mv tmp.json "$super_json"
              rsync -a --partial -q -e "ssh -i ~/.ssh/sf_key -o StrictHostKeyChecking=no" "$super_json" \
              "zuri1503@frs.sourceforge.net:/home/frs/project/projectzk" || exit 1
            fi
          fi
          echo "Super partition size is: $super_size"
          echo "SUPER_SIZE=$super_size" >> $GITHUB_ENV

      - name: Clone ZK AUTO BUILD sources
        run: |
          cd "$GITHUB_WORKSPACE"
          export ZK_HOME="/home/runner/work/ZK_AUTO_BUILD/ZK_AUTO_BUILD"
          echo "ZK_HOME=$ZK_HOME" >> $GITHUB_ENV
          git clone -b main --depth=1 git@github.com:zuri1503/ZK_AUTO_BUILD.git "$ZK_HOME"
          mkdir -p "$ZK_HOME/ROM"
          mv -f "$GITHUB_WORKSPACE/ROM/${ZK_NAME}.zip" "$ZK_HOME/ROM/${ZK_NAME}.zip"
          sudo chmod -R +x "$ZK_HOME"

      - name: Build ProjectZK ROM
        run: |
          cd "$ZK_HOME"
          sudo bash "$ZK_HOME/build.sh" "$GITHUB_ENV" "$ZK_HOME" "$ZK_NAME" "$SUPER_SIZE" \
          "${{ github.event.inputs.EXT4 }}" "${{ github.event.inputs.DECRYPT }}"

      - name: Upload ROM to Clouds
        run: |
          cd "$ZK_HOME"
          export PIXELDRAIN_API_KEY="${{ secrets.PIXELDRAIN_API_KEY }}"
          "$ZK_HOME/tools/pd" upload "$ROM_OUTPUT" > /dev/null 2>&1 || exit 1
          upload_sourceforge() {
            local ROM_OUTPUT="$1"
            local URL="$2"
            rsync -a --partial -q -e "ssh -i ~/.ssh/sf_key -o StrictHostKeyChecking=no" "$ROM_OUTPUT" \
            "zuri1503@frs.sourceforge.net:/home/frs/project/projectzk/ProjectZK/$URL/" || exit 1
          }
          if [ "$ROM_VER" = "V14" ]; then
            upload_sourceforge "$ROM_OUTPUT" "ZK/ZKUI14.0"
          elif [ "$ROM_VER" = "OS2" ]; then
            upload_sourceforge "$ROM_OUTPUT" "ZK/ZKOS2.2"
          elif [ "$ROM_VER" = "OS3" ] || [ "$ROM_VER" = "OS3_A15" ]; then
            upload_sourceforge "$ROM_OUTPUT" "ZK/ZKOS3.0"
          fi
          echo "Uploaded $ZK_NAME"
          sudo rm -rf "$ZK_HOME"
